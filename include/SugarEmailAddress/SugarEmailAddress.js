/**
 *
 * SugarCRM Community Edition is a customer relationship management program developed by
 * SugarCRM, Inc. Copyright (C) 2004-2013 SugarCRM Inc.
 *
 * SuiteCRM is an extension to SugarCRM Community Edition developed by SalesAgility Ltd.
 * Copyright (C) 2011 - 2018 SalesAgility Ltd.
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Affero General Public License version 3 as published by the
 * Free Software Foundation with the addition of the following permission added
 * to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK
 * IN WHICH THE COPYRIGHT IS OWNED BY SUGARCRM, SUGARCRM DISCLAIMS THE WARRANTY
 * OF NON INFRINGEMENT OF THIRD PARTY RIGHTS.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Affero General Public License along with
 * this program; if not, see http://www.gnu.org/licenses or write to the Free
 * Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
 * 02110-1301 USA.
 *
 * You can contact SugarCRM, Inc. headquarters at 10050 North Wolfe Road,
 * SW2-130, Cupertino, CA 95014, USA. or at email address contact@sugarcrm.com.
 *
 * The interactive user interfaces in modified source and object code versions
 * of this program must display Appropriate Legal Notices, as required under
 * Section 5 of the GNU Affero General Public License version 3.
 *
 * In accordance with Section 7(b) of the GNU Affero General Public License version 3,
 * these Appropriate Legal Notices must retain the display of the "Powered by
 * SugarCRM" logo and "Supercharged by SuiteCRM" logo. If the display of the logos is not
 * reasonably feasible for technical reasons, the Appropriate Legal Notices must
 * display the words "Powered by SugarCRM" and "Supercharged by SuiteCRM".
 */
SUGAR.EmailAddressWidget||(SUGAR.EmailAddressWidget=function(e){SUGAR.EmailAddressWidget.count[e]||(SUGAR.EmailAddressWidget.count[e]=0),this.count=SUGAR.EmailAddressWidget.count[e],SUGAR.EmailAddressWidget.count[e]++,this.module=e,this.id=this.count,document.getElementById(e+"_email_widget_id")&&(document.getElementById(e+"_email_widget_id").value=this.id),SUGAR.EmailAddressWidget.instances[this.id]=this},SUGAR.EmailAddressWidget.instances={},SUGAR.EmailAddressWidget.count={},SUGAR.EmailAddressWidget.prototype={totalEmailAddresses:0,replyToFlagObject:new Object,verifying:!1,enterPressed:!1,tabPressed:!1,emailView:"",emailIsRequired:!1,tabIndex:-1,isIE:function(){return!!(0<window.navigator.userAgent.indexOf("MSIE ")||navigator.userAgent.match(/Trident.*rv\:11\./))},prefillEmailAddresses:function(e,a){for(i=0;i<a.length;i++)a[i].email_address=a[i].email_address.replace("&#039;","'"),this.addEmailAddress(e,a[i].email_address,a[i].primary_address,a[i].reply_to_address,a[i].opt_out,a[i].invalid_email,a[i].email_address_id,a[i].confirm_opt_in)},retrieveEmailAddress:function(p){function e(e){var a=jQuery.parseJSON(e.responseText),i=a.target;if(p=this.getEvent(p),a.email){var d=a.email;if(""!=d&&/\d+$/.test(i)){var t=i.match(/\d+$/)[0],s=$("#"+this.module+this.id+"emailAddressOptOutFlag"+t);s&&(s.checked=1==d.opt_out);var r=$("#"+this.module+this.id+"emailAddressInvalidFlag"+t);r&&(r.checked=1==d.invalid_email)}}var l=/[a-z]*\d?emailAddress(\d+)/i.exec(i)[1],n=$("#"+this.module+this.id+"emailAddressVerifiedFlag"+l);1<n.parentNode.childNodes.length&&n.parentNode.removeChild(n.parentNode.lastChild);var m=document.createElement("span");m.innerHTML="",n.parentNode.appendChild(m),n.value="true",this.verifyElementValue=$("#"+this.module+this.id+"emailAddressVerifiedValue"+l),this.verifyElementValue.value=$("#"+this.module+this.id+"emailAddress"+l).value;var o=this.verifying=!1;if(p){var u=document.activeElement||p.explicitOriginalTarget;void 0!==u.type&&/submit|button/.test(u.type.toLowerCase())&&/save|full|cancel|change/.test(u.value.toLowerCase())&&(o=!0)}o||this.enterPressed?setTimeout("SUGAR.EmailAddressWidget.instances."+this.module+this.id+".forceSubmit()",2100):this.tabPressed&&$("#"+this.module+this.id+"emailAddressPrimaryFlag").focus()}p=this.getEvent(p);var a=this.getEventElement(p),i=/[a-z]*\d?emailAddress(\d+)/i.exec(a.id)[1],d=$("#"+this.module+this.id+"emailAddressVerifiedFlag"+i);if(null==this.verifyElementValue||void 0===this.verifyElementValue)return!1;if(this.verifyElementValue=$("#"+this.module+this.id+"emailAddressVerifiedValue"+i),d.value=""==trim(a.value)||a.value==this.verifyElementValue.value?"true":"false",1<d.parentNode.childNodes.length&&d.parentNode.removeChild(d.parentNode.lastChild),/emailAddress\d+$/.test(a.id)&&isValidEmail(a.value)&&!this.verifying&&"false"==d.value){verifiedTextNode=document.createElement("span"),d.parentNode.appendChild(verifiedTextNode),verifiedTextNode.innerHTML=SUGAR.language.get("app_strings","LBL_VERIFY_EMAIL_ADDRESS"),this.verifying=!0;jQuery.get("index.php?module=Contacts&action=RetrieveEmail&target="+a.id+"&email="+a.value).done(e).fail(e)}},handleKeyDown:function(e){var a=this.getEvent(e);this.getEventElement(a);(kc=a.keyCode)&&(this.enterPressed=13==kc,this.tabPressed=9==kc,(this.enterPressed||this.tabPressed)&&(this.retrieveEmailAddress(a),this.enterPressed&&this.freezeEvent(a)))},getEvent:function(e){return e||window.event},getEventElement:function(e){return e.srcElement?e.srcElement:e.target?e.target:e.currentTarget},freezeEvent:function(e){return e.preventDefault&&e.preventDefault(),e.returnValue=!1,e.cancelBubble=!0,e.stopPropagation&&e.stopPropagation(),!1},addEmailAddress:function(e,a,i,d,t,s,r,l){if(_eaw=this,!_eaw.addInProgress){_eaw.addInProgress=!0,a=a||"";var n=$(".template.email-address-line-container").clone();n.removeClass("template"),n.removeClass("hidden"),n.attr("id",this.module+_eaw.id+"emailAddressRow"+_eaw.totalEmailAddresses),n.attr("name",this.module+_eaw.id+"emailAddressRow"+_eaw.totalEmailAddresses);var m=0;void 0!==SUGAR.TabFields&&void 0!==SUGAR.TabFields.email1&&(m=SUGAR.TabFields.email1);var o=n.find("input[type=email]");o.attr("name",this.module+_eaw.id+"emailAddress"+_eaw.totalEmailAddresses),o.attr("id",this.module+_eaw.id+"emailAddress"+_eaw.totalEmailAddresses),o.attr("tabindex",m),o.attr("enabled","true"),""!=a&&o.prop("value",a),o.eaw=_eaw,o.on("blur",function(e){o.eaw.retrieveEmailAddress(e)}),o.on("keydown",function(e){o.eaw.handleKeyDown(e)});var u=n.find("button#email-address-remove-button");u.attr("name",_eaw.totalEmailAddresses),u.attr("id",this.module+_eaw.id+"removeButton"+_eaw.totalEmailAddresses),u.attr("tabindex",m),u.attr("enabled","true"),u.attr("data-row",this.module+_eaw.id+"emailAddressRow"+_eaw.totalEmailAddresses),u.attr("module-id",_eaw.id),u.attr("module-email-id",_eaw.totalEmailAddresses),u.attr("module",this.module),u.click(_eaw.removeEmailAddress);var p=n.find("input#record-id");p.attr("name",this.module+_eaw.id+"emailAddressId"+_eaw.totalEmailAddresses),p.attr("id",this.module+_eaw.id+"emailAddressId"+_eaw.totalEmailAddresses),p.attr("value",void 0!==r?r:""),p.attr("enabled","true");var f=n.find("input#email-address-primary-flag");f.attr("name",_eaw.module+"0emailAddressPrimaryFlag"),f.attr("id",this.module+_eaw.id+"emailAddressPrimaryFlag"),f.attr("value",this.module+_eaw.id+"emailAddress"),f.attr("tabindex",m),f.attr("enabled","true"),f.attr("checked","1"==i),0==_eaw.totalEmailAddresses&&"1"!=i&&f.prop("checked",!0),"Users"==this.module&&f.attr("checked")&&u.prop("disabled",!0);var h=n.find("input#email-address-reply-to-flag");1==h.length&&(h.attr("name",this.module+_eaw.id+"emailAddressReplyToFlag"),h.attr("id",this.module+_eaw.id+"emailAddressReplyToFlag"+_eaw.totalEmailAddresses),h.attr("value",this.module+_eaw.id+"emailAddress"+_eaw.totalEmailAddresses),h.attr("tabindex",m),h.attr("enabled","true"),h.eaw=_eaw,h.prop("checked","1"==d),_eaw.replyToFlagObject[h.attr("id")]="1"==d);var A=n.find("input#email-address-opt-out-flag");1==A.length&&(A.attr("name",this.module+_eaw.id+"emailAddressOptOutFlag[]"),A.attr("id",this.module+_eaw.id+"emailAddressOptOutFlag"+_eaw.totalEmailAddresses),A.attr("value",this.module+_eaw.id+"emailAddress"+_eaw.totalEmailAddresses),A.attr("tabindex",m),A.attr("enabled","true"),A.eaw=_eaw,A.prop("checked","1"==t));var c=n.find("input#email-address-invalid-flag");1==c.length&&(c.attr("name",this.module+_eaw.id+"emailAddressInvalidFlag[]"),c.attr("id",this.module+_eaw.id+"emailAddressInvalidFlag"+_eaw.totalEmailAddresses),c.attr("value",this.module+_eaw.id+"emailAddress"+_eaw.totalEmailAddresses),c.attr("tabindex",m),c.attr("enabled","true"),c.eaw=_eaw,c.prop("checked","1"==s));var v=n.find("input#verified-flag");v.attr("name",this.module+_eaw.id+"emailAddressVerifiedFlag"),v.attr("id",this.module+_eaw.id+"emailAddressVerifiedFlag"+_eaw.totalEmailAddresses),v.attr("value","true");var g=n.find("input#verified-email-value");g.attr("name",this.module+_eaw.id+"emailAddressVerifiedEmailValue"),g.attr("id",this.module+_eaw.id+"emailAddressVerifiedEmailValue"+_eaw.totalEmailAddresses),g.attr("value","true"),n.find("input#Users_email_widget_id").attr("id","Users_email_widget_id"+_eaw.totalEmailAddresses),n.find("input#emailAddressWidget").attr("id","emailAddressWidget"+_eaw.totalEmailAddresses),$(n).appendTo(".email-address-lines-container"),_eaw.EmailAddressValidation(_eaw.emailView,this.module+_eaw.id+"emailAddress"+_eaw.totalEmailAddresses,_eaw.emailIsRequired,SUGAR.language.get("app_strings","LBL_EMAIL_ADDRESS_BOOK_EMAIL_ADDR")),_eaw.totalEmailAddresses+=1,_eaw.numberEmailAddresses=_eaw.totalEmailAddresses,_eaw.addInProgress=!1,_eaw.fixPrimaryRadioCheckboxValue()}},EmailAddressValidation:function(e,a,i,d){$(document).ready(function(){addToValidate(e,a,"email",i,d)})},removeEmailAddress:function(){var i=$(this).attr("module"),d=$(this).attr("module-id"),e=$(this).attr("module-email-id"),a=$(this).attr("data-row"),t=this.name;removeFromValidate($(this).parents("form").attr("name"),i+d+"emailAddress"+e),$("#"+a).remove();$(this).closest("form"),parseInt(t);if(_eaw.totalEmailAddresses=$(".email-address-line-container:not(.template)").length,0==$("[name="+i+d+"emailAddressPrimaryFlag]:checked").length){$("[name="+i+d+"emailAddressPrimaryFlag]").first().prop("checked",!0);var s=$("[name="+i+d+"emailAddressPrimaryFlag]").first().closest(".email-address-line-container").find(".email-address-remove-button").attr("module-email-id");$("[name="+i+d+"emailAddressPrimaryFlag]:checked").val(i+d+"emailAddress"+s)}_eaw.fixPrimaryRadioCheckboxValue();var r="",l=0;return $(".email-address-line-container").each(function(e,a){$(a).hasClass("template")||($(a).find("input[type=email]").first().prop("name",i+d+"emailAddress"+l),$(a).find("input[type=email]").first().prop("id",i+d+"emailAddress"+l),r="",1==$(a).find("input.email-address-primary-flag").first().prop("checked")&&(r=i+d+"emailAddressPrimaryFlag"),$(a).find("input.email-address-primary-flag").first().prop("name",r),$(a).find("input.email-address-primary-flag").first().prop("id",i+d+"emailAddressPrimaryFlag"+l),$(a).find("input.email-address-primary-flag").first().prop("value",i+d+"emailAddress"+l),$(a).find("input.email-address-invalid-flag").first().prop("name",i+d+"emailAddressInvalidFlag[]"),$(a).find("input.email-address-invalid-flag").first().prop("id",i+d+"emailAddressInvalidFlag"+l),$(a).find("input.email-address-invalid-flag").first().prop("value",i+d+"emailAddress"+l),$(a).find("input.email-address-opt-out-flag").first().prop("name",i+d+"emailAddressOptOutFlag[]"),$(a).find("input.email-address-opt-out-flag").first().prop("id",i+d+"emailAddressOptOutFlag"+l),$(a).find("input.email-address-opt-out-flag").first().prop("value",i+d+"emailAddress"+l),$(a).find("input.email-address-opted-in-flag").first().prop("name",i+d+"emailAddressOptInFlag[]"),$(a).find("input.email-address-opted-in-flag").first().prop("id",i+d+"emailAddressOptInFlag"+l),$(a).find("input.email-address-opted-in-flag").first().prop("value",i+d+"emailAddress"+l),$(a).find(".email-address-remove-button").first().prop("name",l),$(a).find(".email-address-remove-button").first().prop("data-row",i+d+"emailAddressRow"+l),$(a).find(".verified-flag").prop("id",i+d+"emailAddressVerifiedFlag"+l),$(a).find(".verified-flag").prop("name",i+d+"emailAddressVerifiedFlag"+l),$(a).find(".verified-email-value").prop("id",i+d+"emailAddressVerifiedValue"+l),$(a).find(".verified-email-value").prop("name",i+d+"emailAddressVerifiedValue"+l),l++)}),!1},fixPrimaryRadioCheckboxValue:function(){$(".email-address-line-container").find('input[type="email"]').each(function(){if(!$(this).hasClass("template")){var e=$(this).attr("name");$(this).closest(".email-address-line-container").find(".email-address-primary-flag").val(e)}}),$('.email-address-lines-container .email-address-line-container:not(.template) input[type="radio"].email-address-primary-flag').each(function(e,a){void 0===$._data($(a),"events")&&$(a).click(function(){$('.email-address-lines-container .email-address-line-container:not(.template) input[type="radio"].email-address-primary-flag').prop("checked",!1),$(this).prop("checked",!0)})})},forceSubmit:function(){var e=$("#"+this.emailView);if(e){if(e.action.value="Save",!check_form(this.emailView))return!1;"EditView"==this.emailView?e.submit():0<this.emailView.indexOf("DCQuickCreate")?DCMenu.save(e.id):0<=this.emailView.indexOf("QuickCreate")&&SUGAR.subpanelUtils.inlineSave(e.id,e.module.value+"_subpanel_save_button")}}},emailAddressWidgetLoaded=!0),$(document).ready(function(){$('.email-address-primary-flag[checked="checked"]').click()});